# 播放器模块文档

## 概述

播放器模块提供实时播放演讲录音和照片同步的功能，包括音频播放控制、照片显示管理和同步协调。

## 架构设计

### 模块结构

```
src/core/player/
├── __init__.py              # 模块导出
├── playback_controller.py   # 播放控制器
├── photo_display.py         # 照片显示管理器
└── sync_coordinator.py      # 同步协调器
```

### 核心组件

#### 1. PlaybackController (播放控制器)

负责音频播放的所有控制功能。

**主要功能：**
- 音频加载和播放
- 播放/暂停/停止控制
- 位置跳转（seek）
- 音量控制
- 播放进度追踪
- 状态管理和事件通知

**依赖：**
- `pygame` - 用于音频播放
- `ffprobe` - 用于获取准确的音频时长

**示例代码：**
```python
from core.player import PlaybackController, PlaybackConfig

# 创建播放器
config = PlaybackConfig(volume=0.8)
controller = PlaybackController(config)

# 加载音频
controller.load(Path("audio.mp3"))

# 播放控制
controller.play()
controller.pause()
controller.seek(30.0)  # 跳转到30秒
controller.set_volume(0.5)

# 获取状态
position = controller.get_position()
duration = controller.get_duration()
is_playing = controller.is_playing()

# 添加回调
def on_position_change(position):
    print(f"Position: {position:.2f}s")

controller.add_position_callback(on_position_change)

# 清理
controller.cleanup()
```

#### 2. PhotoDisplayManager (照片显示管理器)

负责照片的加载、显示和切换。

**主要功能：**
- 加载时间轴照片列表
- 根据时间位置显示对应照片
- 照片预加载（提高性能）
- 照片切换通知
- 内存管理

**依赖：**
- `Pillow (PIL)` - 用于图片处理

**示例代码：**
```python
from core.player import PhotoDisplayManager, DisplayConfig

# 创建管理器
config = DisplayConfig(
    window_size=(1280, 720),
    preload_count=3
)
manager = PhotoDisplayManager(config)

# 加载时间轴
timeline_items = [
    {'photo': 'photo1.jpg', 'duration': 30.0},
    {'photo': 'photo2.jpg', 'duration': 45.0},
    # ...
]
manager.load_timeline(timeline_items, photos_dir)

# 更新显示
changed = manager.update(time_position=15.0)

# 获取当前照片
current_photo = manager.get_current_photo()
if current_photo:
    print(f"Displaying: {current_photo.path.name}")
    image = manager.get_current_image()  # PIL Image对象

# 添加回调
def on_display_change(photo):
    if photo:
        print(f"Now showing: {photo.path.name}")

manager.add_display_callback(on_display_change)

# 清理
manager.cleanup()
```

#### 3. SyncCoordinator (同步协调器)

协调音频播放和照片显示的同步。

**主要功能：**
- 统一管理播放器和显示器
- 自动同步音频和照片
- 时间漂移检测和修正
- 事件驱动架构
- 错误处理

**示例代码：**
```python
from core.player import SyncCoordinator, PlaybackConfig, DisplayConfig, SyncConfig

# 创建协调器
coordinator = SyncCoordinator(
    playback_config=PlaybackConfig(volume=1.0),
    display_config=DisplayConfig(window_size=(1280, 720)),
    sync_config=SyncConfig(update_interval=0.05)
)

# 加载内容
coordinator.load(
    audio_file=Path("audio.mp3"),
    timeline_items=timeline_items,
    photos_dir=Path("photos/")
)

# 播放控制
coordinator.play()
coordinator.pause()
coordinator.stop()
coordinator.seek(60.0)

# 获取状态
info = coordinator.get_sync_info()
print(info)

# 添加回调
def on_sync(position, photo):
    photo_name = photo.path.name if photo else "None"
    print(f"[{position:.2f}s] {photo_name}")

coordinator.add_sync_callback(on_sync)

# 清理
coordinator.cleanup()
```

## 配置说明

### PlaybackConfig

```python
@dataclass
class PlaybackConfig:
    volume: float = 1.0          # 音量 (0.0-1.0)
    speed: float = 1.0           # 播放速度 (0.5-2.0，暂未实现)
    buffer_size: int = 4096      # 缓冲区大小
```

### DisplayConfig

```python
@dataclass
class DisplayConfig:
    window_size: tuple[int, int] = (1280, 720)     # 窗口大小
    transition_type: TransitionType = FADE          # 过渡效果
    transition_duration: float = 0.5                # 过渡时长（秒）
    preload_count: int = 3                          # 预加载照片数量
    background_color: tuple[int, int, int] = (0, 0, 0)  # 背景颜色
```

### SyncConfig

```python
@dataclass
class SyncConfig:
    update_interval: float = 0.05       # 更新间隔（秒），20fps
    sync_tolerance: float = 0.1         # 同步容差（秒）
    auto_correction: bool = True        # 自动时间校正
    correction_threshold: float = 0.5   # 校正阈值（秒）
```

## 使用示例

### 基本播放

```python
from pathlib import Path
from core.player import SyncCoordinator

# 创建协调器
coordinator = SyncCoordinator()

# 准备时间轴数据
timeline_items = [
    {'photo': 'photo1.jpg', 'duration': 30.0},
    {'photo': 'photo2.jpg', 'duration': 45.0},
    {'photo': 'photo3.jpg', 'duration': 25.0},
]

# 加载并播放
if coordinator.load(
    audio_file=Path("lecture.mp3"),
    timeline_items=timeline_items,
    photos_dir=Path("photos/")
):
    coordinator.play()
    
    # 等待播放完成
    import time
    while coordinator.is_playing():
        time.sleep(0.1)
    
    coordinator.cleanup()
```

### 带进度显示的播放

```python
from core.player import SyncCoordinator

coordinator = SyncCoordinator()

# 添加同步回调显示进度
def show_progress(position, photo):
    duration = coordinator.get_duration()
    progress = (position / duration * 100) if duration > 0 else 0
    photo_name = photo.path.name if photo else "None"
    
    print(f"\r[{position:6.2f}s / {duration:6.2f}s] "
          f"{progress:5.1f}% | {photo_name}", 
          end='', flush=True)

coordinator.add_sync_callback(show_progress)

# 加载并播放
coordinator.load(audio_file, timeline_items, photos_dir)
coordinator.play()

# 等待完成...
```

### 交互式控制

```python
import threading
from core.player import SyncCoordinator

coordinator = SyncCoordinator()
coordinator.load(audio_file, timeline_items, photos_dir)
coordinator.play()

# 在后台线程处理用户输入
def handle_input():
    while coordinator.is_playing():
        cmd = input("Command (p=pause, r=resume, s=stop, j=jump): ").strip().lower()
        
        if cmd == 'p':
            coordinator.pause()
        elif cmd == 'r':
            coordinator.play()
        elif cmd == 's':
            coordinator.stop()
            break
        elif cmd == 'j':
            pos = float(input("Jump to (seconds): "))
            coordinator.seek(pos)

input_thread = threading.Thread(target=handle_input, daemon=True)
input_thread.start()

# 等待播放完成...
```

## 命令行工具

### play_lecture.py

提供命令行播放功能。

**使用方法：**

```bash
# 基本播放
python examples/player/play_lecture.py audio.mp3 photos/

# 指定时间轴文件
python examples/player/play_lecture.py audio.mp3 photos/ --timeline timeline.json

# 调整音量
python examples/player/play_lecture.py audio.mp3 photos/ --volume 0.5

# 指定窗口大小
python examples/player/play_lecture.py audio.mp3 photos/ --window-size 1920x1080
```

**参数说明：**

- `audio_file` - 音频文件路径（必需）
- `photos_dir` - 照片目录（必需）
- `--timeline` - 时间轴JSON文件（可选，默认使用metadata.json）
- `--volume` - 音量，0.0-1.0（可选，默认1.0）
- `--window-size` - 窗口大小（可选，默认1280x720）

## 依赖安装

```bash
# 安装播放器依赖
pip install pygame>=2.5.0

# 安装完整依赖（包括图片处理）
pip install -r requirements.txt

# 确保系统已安装FFmpeg
# macOS:
brew install ffmpeg

# Ubuntu:
sudo apt-get install ffmpeg
```

## 事件和回调

### 播放器回调

```python
# 位置变化回调
def on_position_change(position: float):
    print(f"Position: {position:.2f}s")

controller.add_position_callback(on_position_change)

# 状态变化回调
def on_state_change(state: PlaybackState):
    print(f"State: {state.value}")

controller.add_state_callback(on_state_change)
```

### 显示器回调

```python
# 照片切换回调
def on_photo_change(photo: Optional[PhotoItem]):
    if photo:
        print(f"Now showing: {photo.path.name}")

manager.add_display_callback(on_photo_change)
```

### 协调器回调

```python
# 同步更新回调
def on_sync_update(position: float, photo: Optional[PhotoItem]):
    print(f"[{position:.2f}s] {photo.path.name if photo else 'None'}")

coordinator.add_sync_callback(on_sync_update)

# 错误回调
def on_error(error: str):
    print(f"Error: {error}")

coordinator.add_error_callback(on_error)
```

## 性能优化

### 照片预加载

照片显示管理器会自动预加载接下来的N张照片（默认3张），以减少切换时的延迟。

```python
config = DisplayConfig(preload_count=5)  # 预加载5张照片
manager = PhotoDisplayManager(config)
```

### 更新频率控制

可以调整同步更新的频率以平衡性能和响应性。

```python
config = SyncConfig(
    update_interval=0.05  # 20fps，默认值
    # update_interval=0.1  # 10fps，节省资源
)
```

### 内存管理

显示管理器会自动管理图片内存，不需要的图片会被释放。

```python
# 清理资源
manager.cleanup()  # 释放所有加载的图片
```

## 故障排除

### pygame音频问题

**症状：** `ModuleNotFoundError: No module named 'pygame'`

**解决：**
```bash
pip install pygame
```

### FFmpeg不可用

**症状：** 无法获取音频时长

**解决：**
```bash
# macOS
brew install ffmpeg

# Ubuntu
sudo apt-get install ffmpeg
```

### 照片加载失败

**症状：** `FileNotFoundError: Photo not found`

**原因：** 照片路径错误或文件不存在

**解决：**
- 检查照片目录路径是否正确
- 确保timeline中的photo字段与实际文件名匹配

### 音频播放卡顿

**可能原因：**
- 缓冲区太小
- 系统资源不足
- 音频文件损坏

**解决：**
```python
# 增大缓冲区
config = PlaybackConfig(buffer_size=8192)

# 减少预加载数量
display_config = DisplayConfig(preload_count=1)

# 降低更新频率
sync_config = SyncConfig(update_interval=0.1)
```

## 已知限制

1. **倍速播放** - pygame.mixer不原生支持倍速播放，暂未实现
2. **Seek精度** - pygame的seek功能在某些格式上精度有限
3. **实时显示** - 当前仅支持控制台输出，不支持图形界面窗口
4. **过渡效果** - 配置中的过渡效果暂未实现

## 未来改进

- [ ] 添加GUI窗口显示照片
- [ ] 实现照片过渡动画
- [ ] 支持倍速播放
- [ ] 添加播放列表功能
- [ ] 支持暂停时显示进度条
- [ ] 添加键盘快捷键控制
- [ ] 支持全屏模式
- [ ] 添加字幕显示

## API参考

详细API文档请参考各模块的源代码注释。

### PlaybackController

- `load(audio_file)` - 加载音频
- `play()` - 播放
- `pause()` - 暂停
- `stop()` - 停止
- `seek(position)` - 跳转
- `set_volume(volume)` - 设置音量
- `get_position()` - 获取位置
- `get_duration()` - 获取时长
- `is_playing()` - 是否播放中

### PhotoDisplayManager

- `load_timeline(items, dir)` - 加载时间轴
- `update(time_position)` - 更新显
