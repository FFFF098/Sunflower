# 字幕功能文档

> **版本**: v2.0  
> **日期**: 2025-10-24  
> **状态**: 已完成 ✅  
> **功能**: 从音频自动生成字幕并嵌入到视频中

---

## 一、功能概述

字幕服务 (Subtitle Service) 是 v2.0 版本新增的核心功能，使用 OpenAI Whisper 语音识别模型从音频文件自动生成字幕，并将字幕烧录到导出的视频中。

### 主要特性

✨ **自动语音识别** - 使用 OpenAI Whisper 进行高质量语音转文字  
✨ **多语言支持** - 支持中文、英文等多种语言识别  
✨ **多种字幕格式** - 支持 SRT 和 ASS 字幕格式  
✨ **样式自定义** - 支持自定义字幕字体、颜色、大小、位置等  
✨ **字幕嵌入** - 将字幕直接烧录到视频中  
✨ **可选功能** - 字幕生成是可选的，如果不需要可以禁用

---

## 二、安装与配置

### 2.1 安装依赖

字幕功能需要安装 OpenAI Whisper：

```bash
# 安装 Whisper
pip install openai-whisper

# 或者从 requirements.txt 安装
pip install -r requirements.txt
```

**注意**: 
- Whisper 首次使用时会自动下载模型文件（100MB-3GB不等）
- 需要有稳定的网络连接
- 模型文件会缓存在本地，后续使用无需重新下载

### 2.2 系统要求

- **Python**: 3.8+
- **内存**: 建议 4GB 以上
- **存储**: 至少 2GB 可用空间（用于模型文件）
- **处理器**: 支持 CUDA 的 GPU（可选，用于加速）

---

## 三、Whisper 模型说明

Whisper 提供多种模型，性能和准确度各不相同：

| 模型 | 大小 | 内存占用 | 处理速度 | 准确度 | 推荐场景 |
|------|------|---------|---------|--------|---------|
| tiny | ~39MB | ~1GB | 最快 | 较低 | 快速预览 |
| base | ~74MB | ~1GB | 快 | 中等 | **默认推荐** |
| small | ~244MB | ~2GB | 中等 | 良好 | 标准使用 |
| medium | ~769MB | ~5GB | 慢 | 优秀 | 高质量需求 |
| large | ~2.9GB | ~10GB | 很慢 | 最佳 | 专业级质量 |

**推荐配置**:
- **日常使用**: `base` 模型（默认）
- **高质量**: `small` 或 `medium` 模型
- **快速预览**: `tiny` 模型

---

## 四、使用方法

### 4.1 启用字幕（默认已启用）

```python
from services.video.video_exporter import VideoExportConfig

# 字幕默认已启用
config = VideoExportConfig(
    resolution="1280x720",
    enable_subtitles=True  # 默认值
)
```

### 4.2 禁用字幕

```python
config = VideoExportConfig(
    enable_subtitles=False  # 禁用字幕生成
)
```

### 4.3 自定义字幕配置

```python
from services.subtitle.subtitle_service import SubtitleConfig, SubtitleService
from pathlib import Path

# 创建字幕配置
subtitle_config = SubtitleConfig(
    model="small",           # 使用 small 模型
    language="zh",           # 中文
    font_name="Arial",       # 字体
    font_size=24,           # 字体大小
    font_color="white",     # 字体颜色
    outline_color="black",  # 描边颜色
    outline_width=2,        # 描边宽度
    position="bottom"       # 位置（bottom/top/center）
)

# 创建字幕服务
subtitle_service = SubtitleService(subtitle_config)

# 生成字幕
audio_file = Path("audio.mp3")
output_dir = Path("output/subtitles")
subtitle_file = subtitle_service.generate_subtitles(audio_file, output_dir)

print(f"字幕文件: {subtitle_file}")
```

### 4.4 单独使用字幕服务

```python
from services.subtitle.subtitle_service import SubtitleService
from pathlib import Path

# 创建默认字幕服务
service = SubtitleService()

# 生成字幕文件（SRT + ASS）
audio_file = Path("lecture.mp3")
output_dir = Path("subtitles")
subtitle_file = service.generate_subtitles(audio_file, output_dir)

# 获取纯文本转录
transcript = service.get_transcript_text(audio_file)
print(f"转录文本:\n{transcript}")
```

### 4.5 命令行使用

```bash
# 使用字幕服务独立处理音频
python src/services/subtitle/subtitle_service.py audio.mp3 \
    --output-dir output/subtitles \
    --model base \
    --language zh

# 结合视频导出使用（默认启用字幕）
python src/core/lecture_composer.py \
    examples/fixtures/audio.mp3 \
    examples/fixtures/sample-photos/ \
    --export-video
```

---

## 五、字幕配置参数

### 5.1 SubtitleConfig 参数

```python
@dataclass
class SubtitleConfig:
    model: str = "base"              # Whisper模型
    language: str = "zh"             # 语言代码
    font_name: str = "Arial"         # 字体名称
    font_size: int = 24              # 字体大小
    font_color: str = "white"        # 字体颜色
    outline_color: str = "black"     # 描边颜色
    outline_width: int = 2           # 描边宽度
    position: str = "bottom"         # 位置
    max_line_length: int = 42        # 每行最大字符数
```

### 5.2 参数详解

#### model (模型)
- `"tiny"` - 最快，准确度较低
- `"base"` - 默认，平衡速度和准确度
- `"small"` - 较慢，准确度好
- `"medium"` - 慢，准确度优秀
- `"large"` - 很慢，准确度最佳

#### language (语言)
- `"zh"` - 中文（简体/繁体）
- `"en"` - 英文
- `"ja"` - 日文
- `"ko"` - 韩文
- 更多语言请参考 Whisper 文档

#### font_color (字体颜色)
支持的颜色：
- `"white"` - 白色（默认）
- `"black"` - 黑色
- `"yellow"` - 黄色
- `"red"` - 红色
- `"green"` - 绿色
- `"blue"` - 蓝色

#### position (位置)
- `"bottom"` - 底部居中（默认）
- `"top"` - 顶部居中
- `"center"` - 屏幕中央

---

## 六、字幕文件格式

### 6.1 SRT 格式

SRT (SubRip) 是最常用的字幕格式：

```srt
1
00:00:00,000 --> 00:00:05,000
大家好，欢迎来到今天的演讲

2
00:00:05,000 --> 00:00:10,000
今天我要分享的主题是人工智能
```

**特点**:
- 简单易读
- 兼容性极好
- 支持所有播放器

### 6.2 ASS 格式

ASS (Advanced SubStation Alpha) 是高级字幕格式：

```ass
[Script Info]
Title: Auto-generated Subtitles
ScriptType: v4.00+

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, ...
Style: Default,Arial,24,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,...

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
Dialogue: 0,0:00:00.00,0:00:05.00,Default,,0,0,0,,大家好，欢迎来到今天的演讲
```

**特点**:
- 支持复杂样式
- 可自定义字体、颜色、位置
- 更好的视觉效果

---

## 七、工作流程

### 7.1 字幕生成流程

```
输入：音频文件 (MP3/WAV/等)
  ↓
Step 1: 加载 Whisper 模型
  - 首次使用会下载模型
  - 后续使用从缓存加载
  ↓
Step 2: 语音识别
  - 将音频转换为文本
  - 生成时间戳信息
  ↓
Step 3: 生成字幕文件
  - 保存为 SRT 格式
  - 保存为 ASS 格式（含样式）
  ↓
输出：字幕文件 (.srt, .ass)
```

### 7.2 字幕嵌入流程

```
输入：视频文件 + 字幕文件
  ↓
使用 FFmpeg 烧录字幕
  - 将字幕渲染到视频帧中
  - 应用字体、颜色、位置样式
  ↓
输出：带字幕的视频文件
```

---

## 八、性能优化

### 8.1 处理时间估算

以 10 分钟音频为例：

| 模型 | CPU处理时间 | GPU处理时间 | 内存占用 |
|------|------------|------------|---------|
| tiny | ~1分钟 | ~20秒 | ~1GB |
| base | ~2分钟 | ~30秒 | ~1GB |
| small | ~5分钟 | ~1分钟 | ~2GB |
| medium | ~15分钟 | ~3分钟 | ~5GB |
| large | ~30分钟 | ~5分钟 | ~10GB |

**优化建议**:
1. 使用 GPU 加速（需要 CUDA 支持）
2. 选择合适的模型大小
3. 对于长音频，考虑分段处理

### 8.2 GPU 加速

如果系统有 NVIDIA GPU，Whisper 会自动使用 GPU 加速：

```bash
# 安装 GPU 版本的 PyTorch
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# 验证 GPU 可用性
python -c "import torch; print(torch.cuda.is_available())"
```

---

## 九、示例代码

### 9.1 完整示例：视频导出 + 字幕

```python
from pathlib import Path
from core.lecture_composer import LectureComposer
from services.video.video_exporter import VideoExportConfig

# 创建合成器
composer = LectureComposer(
    audio_file=Path("lecture.mp3"),
    photo_files=[Path("photo1.jpg"), Path("photo2.jpg")],
    output_dir=Path("output")
)

# 处理项目
composer.process(title="我的演讲", save=True)

# 配置视频导出（启用字幕）
config = VideoExportConfig(
    resolution="1280x720",
    enable_subtitles=True  # 启用字幕
)

# 导出视频
video_file = composer.export_video(
    output_file=Path("output/lecture_with_subtitles.mp4"),
    config=config
)

print(f"✅ 视频已导出（含字幕）: {video_file}")
```

### 9.2 仅生成字幕文件

```python
from pathlib import Path
from services.subtitle.subtitle_service import SubtitleService, SubtitleConfig

# 配置
config = SubtitleConfig(
    model="base",
    language="zh",
    font_size=28,
    position="bottom"
)

# 创建服务
service = SubtitleService(config)

# 生成字幕
audio_file = Path("lecture.mp3")
output_dir = Path("subtitles")

subtitle_file = service.generate_subtitles(audio_file, output_dir)
print(f"✅ 字幕文件: {subtitle_file}")

# 获取文本转录
text = service.get_transcript_text(audio_file)
print(f"\n📝 转录内容:\n{text}")
```

### 9.3 手动嵌入字幕

```python
from pathlib import Path
from services.subtitle.subtitle_service import SubtitleService

service = SubtitleService()

# 将字幕嵌入到已有视频中
video_file = Path("video.mp4")
subtitle_file = Path("subtitles/lecture.srt")
output_file = Path("video_with_subtitles.mp4")

service.embed_subtitles(video_file, subtitle_file, output_file)
print(f"✅ 字幕已嵌入: {output_file}")
```

---

## 十、常见问题

### 10.1 Whisper 安装失败

**问题**: pip install openai-whisper 失败

**解决方案**:
```bash
# 升级 pip
pip install --upgrade pip

# 重新安装
pip install openai-whisper

# 如果仍然失败，尝试使用清华源
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple openai-whisper
```

### 10.2 模型下载失败

**问题**: 首次使用时模型下载超时

**解决方案**:
1. 检查网络连接
2. 使用代理或VPN
3. 手动下载模型文件到缓存目录
4. 使用较小的模型（如 tiny 或 base）

### 10.3 字幕识别不准确

**问题**: 生成的字幕文本错误较多

**解决方案**:
1. 使用更大的模型（如 medium 或 large）
2. 确保音频质量良好（清晰、无噪音）
3. 指定正确的语言代码
4. 对于方言，可能需要使用 large 模型

### 10.4 处理速度太慢

**问题**: 字幕生成耗时过长

**解决方案**:
1. 使用较小的模型（tiny 或 base）
2. 启用 GPU 加速
3. 对长音频进行分段处理
4. 考虑使用专门的服务器进行处理

### 10.5 字幕不显示或乱码

**问题**: 视频中字幕不显示或显示乱码

**解决方案**:
1. 检查字幕文件编码（应为 UTF-8）
2. 确认 FFmpeg 正确安装
3. 尝试不同的字体
4. 检查视频播放器是否支持内嵌字幕

---

## 十一、最佳实践

### 11.1 音频质量要求

为获得最佳识别效果，音频应满足：
- **清晰度**: 语音清晰，背景噪音少
- **音量**: 适中，不要过大或过小
- **格式**: MP3、WAV、M4A 等常见格式
- **采样率**: 16kHz 以上

### 11.2 字幕样式建议

- **字体大小**: 24-28px 适合 720p/1080p
- **颜色**: 白字黑边对比度最好
- **位置**: 底部居中，不遮挡重要内容
- **描边**: 2-3px 的描边确保可读性

### 11.3 工作流程建议

1. **先用小模型预览**: 使用 tiny 或 base 快速生成初版
2. **检查并修正**: 检查字幕准确性，必要时手动修正
3. **使用大模型精修**: 最终版本使用 small 或 medium
4. **保存字幕文件**: 保留 SRT 文件供后续编辑

---

## 十二、更新日志

### v2.0 (2025-10-24)
- ✨ 新增自动字幕生成功能
- ✨ 集成 OpenAI Whisper 语音识别
- ✨ 支持 SRT 和 ASS 字幕格式
- ✨ 支持自定义字幕样式
- ✨ 自动将字幕嵌入到视频中
- ✨ 默认启用字幕功能（可选）

---

## 十三、参考资源

- [OpenAI Whisper GitHub](https://github.com/openai/whisper)
- [Whisper 模型文档](https://github.com/openai/whisper#available-models-and-languages)
- [FFmpeg 字幕滤镜文档](https://ffmpeg.org/ffmpeg-filters.html#subtitles-1)
- [SRT 格式规范](https://en.wikipedia.org/wiki/SubRip)
- [ASS 格式规范](http://www.tcax.org/docs/ass-specs.htm)
