# 集成测试指南

> 端到端测试流程，验证系统各模块间的协作

---

## 📋 测试概述

集成测试验证系统各组件之间的交互，确保完整的用户流程正常工作。

### 测试范围

- ✅ Web API 集成测试
- ✅ 前后端交互测试
- ✅ 文件上传流程测试
- ✅ 播放器功能测试
- ✅ 会话管理测试

---

## 🚀 快速开始

### 环境准备

```bash
# 1. 确保所有依赖已安装
cd lecture-video-composer
pip install -r requirements.txt

# 2. 启动测试服务器
python run_web.py &

# 3. 等待服务启动
sleep 3
```

### 运行测试

```bash
# 运行所有集成测试
pytest tests/web/ -v

# 运行特定模块测试
pytest tests/web/test_file_api.py -v
pytest tests/web/test_playback_api.py -v
pytest tests/web/test_project_api.py -v
```

---

## 🧪 测试场景

### 1. 文件上传流程

**测试目标**：验证文件上传的完整流程

```python
def test_file_upload_workflow(client):
    """测试文件上传工作流"""
    # 1. 上传音频文件
    audio_response = upload_audio_file(client)
    assert audio_response.status_code == 200
    
    # 2. 上传照片文件
    photo_response = upload_photo_files(client)
    assert photo_response.status_code == 200
    
    # 3. 验证文件列表
    files = get_uploaded_files(client)
    assert len(files['audio']) > 0
    assert len(files['photos']) > 0
```

**验证点**：
- ✅ 文件正确上传到服务器
- ✅ 文件名解析正确（时间戳提取）
- ✅ 文件类型验证
- ✅ 文件大小限制

### 2. 项目创建流程

**测试目标**：验证项目创建和管理

```python
def test_project_creation(client):
    """测试项目创建流程"""
    # 1. 创建新项目
    project_data = {
        'name': '测试项目',
        'audio_file': 'test-audio.mp3',
        'photo_files': ['photo1.jpg', 'photo2.jpg']
    }
    
    response = client.post('/api/projects', json=project_data)
    assert response.status_code == 201
    
    project = response.json
    assert 'project_id' in project
    assert 'timeline' in project
```

**验证点**：
- ✅ 项目成功创建
- ✅ 时间轴正确生成
- ✅ 文件关联正确
- ✅ 元数据持久化

### 3. 播放器功能测试

**测试目标**：验证播放控制功能

```python
def test_playback_controls(client, project_id):
    """测试播放控制"""
    # 1. 初始化播放器
    init_response = client.post(f'/api/playback/{project_id}/init')
    assert init_response.status_code == 200
    
    # 2. 播放
    play_response = client.post(f'/api/playback/{project_id}/play')
    assert play_response.status_code == 200
    
    # 3. 暂停
    pause_response = client.post(f'/api/playback/{project_id}/pause')
    assert pause_response.status_code == 200
    
    # 4. 跳转
    seek_response = client.post(
        f'/api/playback/{project_id}/seek',
        json={'time': 30.0}
    )
    assert seek_response.status_code == 200
```

**验证点**：
- ✅ 播放控制正常响应
- ✅ 状态同步正确
- ✅ 时间轴跳转准确

### 4. 会话管理测试

**测试目标**：验证多用户会话隔离

```python
def test_session_isolation(client):
    """测试会话隔离"""
    # 创建两个独立会话
    with client.session_transaction() as sess1:
        sess1['user_id'] = 'user1'
    
    with client.session_transaction() as sess2:
        sess2['user_id'] = 'user2'
    
    # 验证数据隔离
    files1 = get_user_files(client, 'user1')
    files2 = get_user_files(client, 'user2')
    
    assert files1 != files2
```

**验证点**：
- ✅ 会话正确创建
- ✅ 用户数据隔离
- ✅ 会话持久化

---

## 📊 测试覆盖

### 当前覆盖率

```
模块                    覆盖率
-------------------------
src/web/api/           95%  ✅
src/web/services/      90%  ✅
src/core/player/       85%  ✅
src/core/timeline/     88%  ✅
src/services/          80%  🚧
-------------------------
总体覆盖率:            87%  ✅
```

### API 端点测试

| 端点 | 方法 | 测试状态 |
|------|------|----------|
| `/api/files/upload` | POST | ✅ 完成 |
| `/api/files/list` | GET | ✅ 完成 |
| `/api/projects` | GET/POST | ✅ 完成 |
| `/api/projects/<id>` | GET/DELETE | ✅ 完成 |
| `/api/playback/<id>/init` | POST | ✅ 完成 |
| `/api/playback/<id>/play` | POST | ✅ 完成 |
| `/api/playback/<id>/pause` | POST | ✅ 完成 |
| `/api/playback/<id>/seek` | POST | ✅ 完成 |
| `/api/playback/<id>/state` | GET | ✅ 完成 |

---

## 🐛 常见问题

### 1. 测试数据清理

**问题**：测试后残留数据影响下次测试

**解决方案**：
```python
@pytest.fixture(autouse=True)
def cleanup_test_data():
    """自动清理测试数据"""
    yield
    # 清理上传的文件
    clean_uploads_dir()
    # 清理项目数据
    clean_projects_dir()
```

### 2. 端口占用

**问题**：测试服务器端口被占用

**解决方案**：
```bash
# 查找占用进程
lsof -i :5000

# 终止进程
kill -9 <PID>
```

### 3. 会话状态

**问题**：测试间会话状态互相干扰

**解决方案**：
```python
@pytest.fixture
def client(app):
    """为每个测试创建独立客户端"""
    with app.test_client() as client:
        with app.app_context():
            yield client
```

---

## 📝 最佳实践

### 1. 测试隔离

- ✅ 每个测试使用独立的数据
- ✅ 测试后清理资源
- ✅ 避免测试间依赖

### 2. 断言清晰

```python
# ❌ 不好的断言
assert response

# ✅ 好的断言
assert response.status_code == 200
assert 'project_id' in response.json
```

### 3. 测试命名

```python
# 清晰的测试名称
def test_upload_audio_file_with_valid_format():
    """测试上传有效格式的音频文件"""
    pass

def test_upload_photo_file_with_timestamp_in_name():
    """测试上传包含时间戳的照片文件"""
    pass
```

### 4. 使用 Fixture

```python
@pytest.fixture
def sample_audio_file():
    """提供测试用音频文件"""
    return ('audio.mp3', io.BytesIO(b'audio content'), 'audio/mpeg')

@pytest.fixture
def sample_project(client):
    """创建测试项目"""
    response = client.post('/api/projects', json={...})
    return response.json['project_id']
```

---

## 🔄 持续集成

### GitHub Actions 配置

```yaml
name: Integration Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run integration tests
      run: |
        pytest tests/web/ -v --cov
```

---

## 📚 相关文档

- [快速测试指南](./快速测试指南.md) - 基础功能测试
- [字幕问题排查指南](./字幕问题排查指南.md) - 字幕功能调试
- [Web API 文档](../api/Web_API文档.md) - API 接口定义

---

<p align="center">
  <sub>最后更新：2025-10-26</sub>
</p>
