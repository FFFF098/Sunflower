# 文件上传重命名问题修复

## 问题描述

用户上传文件时，原始文件名（如 `2025-10-24-15:15:15.mp3`）被改成生成的文件名（如 `audio_20251025_225350.mp3`），导致后端处理失败。

## 根本原因

系统的时间轴同步功能**完全依赖**文件名中的特定时间戳格式来工作：

### 依赖的文件名格式
```
YYYY-MM-DD-hh:mm:ss.ext
例如：2025-10-24-15:15:15.mp3
```

### 核心依赖模块

1. **TimelineSync.parse_timestamp()** (`src/core/timeline/timeline_sync.py`)
   - 从文件名中解析时间戳
   - 格式：`%Y-%m-%d-%H:%M:%S`
   - 如果格式不匹配，抛出 `ValueError`

2. **TimelineSync.build_timeline()** 
   - 解析音频文件的开始时间
   - 解析每张照片的拍摄时间
   - 计算照片相对于音频的时间偏移量
   - 建立时间轴同步关系

3. **TimelineSync.validate_files()**
   - 验证所有文件名格式是否符合要求
   - 在 `LectureComposer.validate_inputs()` 中调用

### 问题流程

```
用户上传 2025-10-24-15:15:15.mp3
    ↓
file_api.py 重命名为 audio_20251025_225350.mp3
    ↓
创建项目时调用 LectureComposer
    ↓
TimelineSync.validate_files() 尝试解析文件名
    ↓
parse_timestamp() 失败（格式不匹配）
    ↓
❌ 验证失败：Input validation failed
```

## 解决方案

修改 `save_uploaded_file()` 函数，保留原始文件名而不是生成新文件名。

### 修改前
```python
def save_uploaded_file(file: FileStorage, upload_dir: Path, prefix: str = '') -> Path:
    # 生成新文件名
    original_filename = secure_filename(file.filename)
    ext = Path(original_filename).suffix
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    
    if prefix:
        filename = f"{prefix}_{timestamp}{ext}"  # ❌ 生成新名称
    else:
        name = Path(original_filename).stem
        filename = f"{name}_{timestamp}{ext}"
    
    filepath = upload_dir / filename
    file.save(str(filepath))
    return filepath
```

### 修改后
```python
def save_uploaded_file(file: FileStorage, upload_dir: Path, prefix: str = '') -> Path:
    # 保留原始文件名
    original_filename = secure_filename(file.filename)
    
    # 处理文件名冲突
    filepath = upload_dir / original_filename
    if filepath.exists():
        # 只有在冲突时才添加时间戳后缀
        stem = Path(original_filename).stem
        ext = Path(original_filename).suffix
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f"{stem}_{timestamp}{ext}"
        filepath = upload_dir / filename
        current_app.logger.warning(f"File {original_filename} already exists, renamed to {filename}")
    
    file.save(str(filepath))
    return filepath
```

## 关键改进

1. ✅ **保留原始文件名**：维持时间戳格式不变
2. ✅ **冲突处理**：只有在文件已存在时才重命名
3. ✅ **向后兼容**：不影响其他功能
4. ✅ **安全性**：仍然使用 `secure_filename()` 进行安全检查

## 影响范围

- `src/web/api/file_api.py` - `save_uploaded_file()` 函数
- 影响音频和照片文件上传
- 确保后端能正确处理时间轴同步

## 测试建议

1. 上传符合格式的文件（`2025-10-24-15:15:15.mp3`）
2. 验证文件名保持不变
3. 创建项目，确认时间轴正确构建
4. 测试文件名冲突场景

## 相关文件

- `lecture-video-composer/src/web/api/file_api.py` - 文件上传API
- `lecture-video-composer/src/core/timeline/timeline_sync.py` - 时间轴同步引擎
- `lecture-video-composer/src/core/lecture_composer.py` - 主控制器

## 日期

2025-10-25
