# 文件上传显示问题修复

## 问题描述

用户报告文件上传后页面没有显示对应文件，虽然服务器日志显示上传成功。同时发现文件名中的冒号被移除了（例如：`2025-10-24-15:15:15.mp3` 变成了 `2025-10-24-151515.mp3`）。

## 问题日志

```
INFO:src.web.app:Audio file uploaded: audio_20251025_220025.mp3
INFO:werkzeug:127.0.0.1 - - [25/Oct/2025 22:00:25] "POST /api/file/upload/audio HTTP/1.1" 200 -
INFO:werkzeug:127.0.0.1 - - [25/Oct/2025 22:00:25] "GET /api/file/list?session_id=... HTTP/1.1" 200 -
```

可以看到：
1. 文件上传成功（200状态码）
2. 文件列表API调用成功（200状态码）
3. 但页面没有更新显示

## 根本原因分析

### 问题1: 删除文件API参数不匹配

**前端代码** (`app.js`):
```javascript
await this.api.post('/file/delete', { 
    path,  // ❌ 错误
    session_id: sessionId
});
```

**后端代码** (`file_api.py`):
```python
filepath_str = data.get('filepath')  # 期望 'filepath'
```

前后端参数名不匹配导致删除功能失败，影响整体文件管理流程。

### 问题2: 文件名格式问题

**原因**: `secure_filename()` 函数会移除特殊字符，包括冒号 `:`

**影响**: 时间戳格式 `YYYY-MM-DD-HH:MM:SS` 中的冒号被移除
- 原文件名: `2025-10-24-15:15:15.mp3`
- 实际保存: `2025-10-24-151515.mp3`

这违反了系统对时间戳格式的要求，时间轴同步依赖于正确的时间戳格式。

## 修复方案

### 修复1: 统一删除API参数名

**文件**: `lecture-video-composer/src/web/static/js/app.js`

```javascript
async deleteFile(path, type) {
    confirm('确认删除该文件？', async () => {
        try {
            const sessionId = this.state.get('session.sessionId');
            await this.api.post('/file/delete', { 
                filepath: path,  // ✅ 修改为 filepath
                session_id: sessionId
            });
            showNotification('文件已删除', 'success');
            this.updateFileList();
        } catch (error) {
            showNotification('删除失败: ' + error.message, 'error');
        }
    });
}
```

### 修复2: 保留文件名中的冒号

**文件**: `lecture-video-composer/src/web/api/file_api.py`

**修改前**:
```python
def save_uploaded_file(file: FileStorage, upload_dir: Path, prefix: str = '') -> Path:
    # ...
    original_filename = secure_filename(file.filename)  # ❌ 会移除冒号
    # ...
```

**修改后**:
```python
def save_uploaded_file(file: FileStorage, upload_dir: Path, prefix: str = '') -> Path:
    """保存上传的文件，保留时间戳格式中的冒号"""
    upload_dir.mkdir(parents=True, exist_ok=True)
    
    # 不使用 secure_filename，因为它会移除冒号
    original_filename = file.filename
    
    # 基本安全检查：只保留安全字符，包括冒号
    safe_chars = set('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_.:')
    filename = ''.join(c for c in original_filename if c in safe_chars)
    
    # 确保文件名有效
    if not filename or filename.startswith('.'):
        ext = Path(original_filename).suffix if '.' in original_filename else ''
        timestamp = datetime.now().strftime('%Y-%m-%d-%H:%M:%S')
        filename = f"{prefix}{timestamp}{ext}" if prefix else f"{timestamp}{ext}"
    
    # 处理文件名冲突
    filepath = upload_dir / filename
    if filepath.exists():
        stem = Path(filename).stem
        ext = Path(filename).suffix
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f"{stem}_{timestamp}{ext}"
        filepath = upload_dir / filename
        current_app.logger.warning(f"File {original_filename} already exists, renamed to {filename}")
    
    file.save(str(filepath))
    return filepath
```

## 安全性考虑

虽然不使用 `secure_filename()`，但我们实现了自定义的安全检查：

1. **白名单字符过滤**: 只允许字母、数字、连字符、下划线、点和冒号
2. **路径遍历防护**: 不允许路径分隔符 `/` 和 `\`
3. **隐藏文件防护**: 检查文件名不以 `.` 开头
4. **文件冲突处理**: 自动添加时间戳后缀避免覆盖

## 测试验证

### 测试步骤

1. **上传音频文件**:
   - 文件名: `2025-10-24-15:15:15.mp3`
   - 预期: 保存为 `2025-10-24-15:15:15.mp3`（保留冒号）

2. **上传照片文件**:
   - 文件名: `2025-10-24-15:15:15.jpg`
   - 预期: 保存为 `2025-10-24-15:15:15.jpg`（保留冒号）

3. **查看文件列表**:
   - 预期: 上传后立即在页面显示文件

4. **删除文件**:
   - 点击删除按钮
   - 确认删除
   - 预期: 文件成功删除，页面立即更新

### 预期结果

✅ 文件名格式正确保留时间戳中的冒号
✅ 上传后立即显示在文件列表中
✅ 删除功能正常工作
✅ 时间轴同步功能正常（依赖正确的时间戳格式）

## 相关文件

- `lecture-video-composer/src/web/static/js/app.js` - 前端应用主逻辑
- `lecture-video-composer/src/web/api/file_api.py` - 文件上传API
- `lecture-video-composer/src/core/timeline/timeline_sync.py` - 时间轴同步（依赖时间戳格式）

## 修复日期

2025-10-25

## 修复者

Cline (AI Assistant)
